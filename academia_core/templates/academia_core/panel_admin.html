{% extends "core/base.html" %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}
  <div class="row">
    <nav class="col-md-2 col-lg-2 d-md-block sidebar rounded-3 shadow-sm p-3 sidebar-surface">
      <div class="position-sticky">
        <h3 class="h5">Acciones</h3>
        <ul class="nav flex-column nav-pills">
          <li class="nav-item">
            <a href="?action=section_home" class="nav-link {% if action == 'section_home' %}active{% endif %}">Dashboard</a>
          </li>
          <li class="nav-item">
            <a href="?action=section_est" class="nav-link {% if action == 'section_est' or action == 'add_est' %}active{% endif %}">Estudiantes</a>
          </li>
          <li class="nav-item">
            <a href="?action=section_insc"
               class="nav-link {% if action == 'section_insc' or action == 'insc_carrera' or action == 'insc_prof' or action == 'insc_esp' or action == 'insc_final' %}active{% endif %}">
              Inscripciones
            </a>
          </li>
          <li class="nav-item">
            <a href="?action=section_calif" class="nav-link {% if action == 'section_calif' %}active{% endif %}">Calificaciones</a>
          </li>
          <li class="nav-item">
            <a href="?action=section_correlatividades" class="nav-link {% if action == 'section_correlatividades' %}active{% endif %}">Correlatividades</a>
          </li>
          {% if can_admin %}
          <li class="nav-item">
            <a href="?action=section_admin" class="nav-link {% if action == 'section_admin' %}active{% endif %}">Administración</a>
          </li>
          {% endif %}
          <li class="nav-item">
            <a href="?action=section_help" class="nav-link {% if action == 'section_help' %}active{% endif %}">Ayuda</a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="col-md-10 col-lg-10 px-3">
      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags }} alert-dismissible fade show" role="alert">
            {{ m }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      {% endif %}
      <div class="bg-white rounded-3 shadow-sm compact main-scroll p-2 form-surface">
        {% if action_subtitle %}<p class="text-muted">{{ action_subtitle|safe }}</p>{% endif %}

        {# ===================== ESTUDIANTES ===================== #}
        {% if action == 'section_est' %}
          <ul class="list-unstyled">
            <li><a href="?action=add_est" class="btn btn-primary">➜ Nuevo estudiante</a></li>
          </ul>

        {# ===================== DASHBOARD ===================== #}
        {% elif action == 'section_home' %}
          <h2 class="h4">Resumen General</h2>
          <div class="row row-cols-1 row-cols-md-3 g-4">
            <div class="col">
              <div class="card text-center h-100">
                <div class="card-body">
                  <h5 class="card-title">Estudiantes</h5>
                  <p class="card-text display-4">{{ total_estudiantes }}</p>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card text-center h-100">
                <div class="card-body">
                  <h5 class="card-title">Profesorados</h5>
                  <p class="card-text display-4">{{ total_profesorados }}</p>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card text-center h-100">
                <div class="card-body">
                  <h5 class="card-title">Espacios Curriculares</h5>
                  <p class="card-text display-4">{{ total_espacios }}</p>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card text-center h-100">
                <div class="card-body">
                  <h5 class="card-title">Inscripciones a Carrera</h5>
                  <p class="card-text display-4">{{ total_inscripciones_carrera }}</p>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card text-center h-100">
                <div class="card-body">
                  <h5 class="card-title">Inscripciones a Materia</h5>
                  <p class="card-text display-4">{{ total_inscripciones_materia }}</p>
                </div>
              </div>
            </div>
          </div>
          <h2 class="h4 mt-4">Accesos Rápidos</h2>
          <ul class="list-unstyled">
            <li><a href="?action=add_est" class="btn btn-outline-primary mb-2">➜ Nuevo Estudiante</a></li>
            <li><a href="?action=insc_carrera" class="btn btn-outline-primary mb-2">➜ Inscribir a Carrera</a></li>
            <li><a href="?action=insc_esp" class="btn btn-outline-primary mb-2">➜ Inscribir a Materia</a></li>
            <li><a href="{% url 'cargar_nota' %}" class="btn btn-outline-primary mb-2">➜ Cargar Nota</a></li>
          </ul>

        {# ===================== CALIFICACIONES ===================== #}
        {% elif action == 'section_calif' %}
          <ul class="list-unstyled">
            <li><a href="{% url 'cargar_nota' %}" class="btn btn-primary">➜ Cargar Nota</a></li>
          </ul>

        {# ===================== CORRELATIVIDADES ===================== #}
        {% elif action == 'section_correlatividades' %}
          <h2 class="h4">Gestión de Correlatividades</h2>
          <form method="post">
            {% csrf_token %}
                        <div class="mb-3">
              <label for="id_profesorado" class="form-label">Profesorado</label>
              <select name="profesorado" id="id_profesorado" class="form-select">
                {% for value, label in form.profesorado.field.choices %}
                  <option value="{{ value }}" {% if form.profesorado.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="id_plan" class="form-label">Plan de Estudios</label>
              <select name="plan" id="id_plan" class="form-select">
                {% for value, label in form.plan.field.choices %}
                  <option value="{{ value }}" {% if form.plan.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="id_materia_principal" class="form-label">Materia Principal</label>
              <select name="materia_principal" id="id_materia_principal" class="form-select">
                {% for value, label in form.materia_principal.field.choices %}
                  <option value="{{ value }}" {% if form.materia_principal.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Correlativas (condición regular)</label>
              <div id="id_correlativas_regulares">
                {% for checkbox in form.correlativas_regulares %}
                  <div class="form-check">
                    <input type="checkbox" name="{{ checkbox.name }}" id="{{ checkbox.id_for_label }}" value="{{ checkbox.value }}" class="form-check-input" {% if checkbox.data.selected %}checked{% endif %}>
                    <label for="{{ checkbox.id_for_label }}" class="form-check-label">{{ checkbox.choice_label }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Correlativas (aprobadas)</label>
              <div id="id_correlativas_aprobadas">
                {% for checkbox in form.correlativas_aprobadas %}
                  <div class="form-check">
                    <input type="checkbox" name="{{ checkbox.name }}" id="{{ checkbox.id_for_label }}" value="{{ checkbox.value }}" class="form-check-input" {% if checkbox.data.selected %}checked{% endif %}>
                    <label for="{{ checkbox.id_for_label }}" class="form-check-label">{{ checkbox.choice_label }}</label>
                  </div>
                {% endfor %}
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Guardar Correlatividades</button>
          </form>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const profesoradoSelect = document.getElementById('id_profesorado');
    console.log('profesoradoSelect element:', profesoradoSelect);
    const planSelect = document.getElementById('id_plan');
    const materiaPrincipalSelect = document.getElementById('id_materia_principal');
    const correlativasRegularesDiv = document.getElementById('id_correlativas_regulares');
    const correlativasAprobadasDiv = document.getElementById('id_correlativas_aprobadas');

    // Helper to parse URL parameters
    function getUrlParameter(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }

    // Function to fetch and populate select dropdowns
    function fetchAndPopulateSelect(url, selectElement, selectedValue = null) {
      fetch(url)
        .then(response => response.json())
        .then(data => {
          selectElement.innerHTML = '<option value="">-- Seleccione --</option>';
          data.items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.nombre;
            if (selectedValue && String(selectedValue) === String(item.id)) { // Ensure type consistency
              option.selected = true;
            }
            selectElement.appendChild(option);
          });
          selectElement.dispatchEvent(new Event('change')); // Trigger change for cascading
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    // Function to fetch and populate checkboxes
    function fetchAndPopulateCheckboxes(url, divElement, selectedValues = []) {
      console.log('fetchAndPopulateCheckboxes called for:', divElement.id, 'with URL:', url, 'and selectedValues:', selectedValues);
      fetch(url)
        .then(response => {
          console.log('Response from fetchAndPopulateCheckboxes URL:', response);
          return response.json();
        })
        .then(data => {
          console.log('Data received by fetchAndPopulateCheckboxes for', divElement.id, ':', data);
          if (!data.items || data.items.length === 0) {
            console.warn('No items received for checkboxes in', divElement.id);
          }
          divElement.innerHTML = ''; // Clear existing checkboxes
          const selectedSet = new Set(selectedValues.map(String)); // Convert to Set for efficient lookup
          data.items.forEach(item => {
            const idStr = String(item.id); // Ensure ID is string for comparison
            const div = document.createElement('div');
            div.className = 'form-check';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.name = divElement.id.replace('id_', ''); // e.g., correlativas_regulares
            input.id = divElement.id + '_' + idStr;
            input.value = idStr;
            if (selectedSet.has(idStr)) { // Check against the set of selected values
              input.checked = true;
            }
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = input.id;
            label.textContent = item.nombre;

            div.appendChild(input);
            div.appendChild(label);
            divElement.appendChild(div);
          });
        })
        .catch(error => console.error('Error in fetchAndPopulateCheckboxes for', divElement.id, ':', error));
    }

    // Initial load: Read URL parameters and trigger changes
    const initialProfesorado = getUrlParameter('profesorado');
    const initialPlan = getUrlParameter('plan');
    const initialMateriaPrincipal = getUrlParameter('materia_principal');

    // Get initial selected checkbox IDs from Django context
    const initialCorrelativasRegulares = {{ form.correlativas_regulares.value|default:"[]"|safe }};
    const initialCorrelativasAprobadas = {{ form.correlativas_aprobadas.value|default:"[]"|safe }};


    // Event listeners for cascading dropdowns
    profesoradoSelect.addEventListener('change', function() {
      const profesoradoId = this.value;
      console.log('Profesorado ID selected:', profesoradoId);
      if (profesoradoId) {
        fetchAndPopulateSelect(`/api/planes-por-profesorado/?profesorado_id=${encodeURIComponent(profesoradoId)}`, planSelect, initialPlan);
      } else {
        planSelect.innerHTML = '<option value="">-- Seleccione un Plan --</option>';
        materiaPrincipalSelect.innerHTML = '<option value="">-- Seleccione una Materia --</option>';
        correlativasRegularesDiv.innerHTML = '';
        correlativasAprobadasDiv.innerHTML = '';
      }
    });

    planSelect.addEventListener('change', function() {
      const planId = this.value;
      if (planId) {
        fetchAndPopulateSelect(`/api/espacios-por-plan/?plan_id=${encodeURIComponent(planId)}`, materiaPrincipalSelect, initialMateriaPrincipal);
        // Clear checkboxes when plan changes, before materia is selected
        correlativasRegularesDiv.innerHTML = '';
        correlativasAprobadasDiv.innerHTML = '';
      }
    });

    materiaPrincipalSelect.addEventListener('change', function() {
      const materiaId = this.value;
      const planId = planSelect.value; // Get the currently selected plan ID

      // Always clear checkboxes when materia changes
      correlativasRegularesDiv.innerHTML = '';
      correlativasAprobadasDiv.innerHTML = '';

      if (materiaId && planId) {
        console.log('Fetching correlativities from:', `/api/correlatividades-por-materia/?materia_id=${encodeURIComponent(materiaId)}&plan_id=${encodeURIComponent(planId)}`);
        fetch(`/api/correlatividades-por-materia/?materia_id=${encodeURIComponent(materiaId)}&plan_id=${encodeURIComponent(planId)}`)
          .then(response => {
            console.log('Response from /api/correlatividades-por-materia/:', response);
            return response.json();
          })
          .then(data => {
            console.log('API response for correlativities:', data);
            console.log('Calling fetchAndPopulateCheckboxes for regulares. URL:', `/api/espacios-por-plan/?plan_id=${encodeURIComponent(planId)}`, 'Selected:', data.regulares);
            console.log('Calling fetchAndPopulateCheckboxes for aprobadas. URL:', `/api/espacios-por-plan/?plan_id=${encodeURIComponent(planId)}`, 'Selected:', data.aprobadas);

            // Now populate with the correct selected values
            fetchAndPopulateCheckboxes(`/api/espacios-por-plan/?plan_id=${encodeURIComponent(planId)}`, correlativasRegularesDiv, data.regulares);
            fetchAndPopulateCheckboxes(`/api/espacios-por-plan/?plan_id=${encodeURIComponent(planId)}`, correlativasAprobadasDiv, data.aprobadas);
          })
          .catch(error => console.error('Error fetching correlativities for materia:', error));
      }
    });

    // Initial load logic
    if (initialProfesorado) {
      profesoradoSelect.value = initialProfesorado;
      profesoradoSelect.dispatchEvent(new Event('change'));
    } else if (initialPlan) { // Only trigger plan change if no initialProfesorado
      planSelect.value = initialPlan;
      planSelect.dispatchEvent(new Event('change'));
    }

    // After initial load, if materiaPrincipal is already selected, trigger its change event
    // This handles cases where the page loads with all three parameters (profesorado, plan, materia_principal)
    // This needs to be delayed slightly to ensure materiaPrincipalSelect is populated.
    if (initialMateriaPrincipal) {
        // A small delay to ensure the materiaPrincipalSelect is populated by the previous change events
        setTimeout(() => {
            materiaPrincipalSelect.value = initialMateriaPrincipal;
            materiaPrincipalSelect.dispatchEvent(new Event('change'));
        }, 100); // Adjust delay if needed
    }
  });
</script>

        {# ===================== INSCRIPCIÓN A CARRERA ===================== #}
        {% elif action == 'insc_carrera' or action == 'insc_prof' %}
<form id="form-insc-carrera" class="row g-2 gy-1 compact" novalidate>
  <div class="col-12"><h6 class="text-uppercase text-muted mb-2">INSCRIPCIÓN A CARRERA</h6></div>

  <!-- Estudiante -->
  <div class="col-12 col-lg-6">
    <label class="form-label">Estudiante <span class="text-danger">*</span></label>
    <select id="estudiante" name="estudiante" class="form-select">
      <option value="" selected>Seleccioná...</option>
      {% for e in estudiantes %}
        <option value="{{ e.id }}">{{ e.apellido }}, {{ e.nombre }} — DNI {{ e.dni }}</option>
      {% empty %}
        <option disabled>No hay estudiantes activos</option>
      {% endfor %}
    </select>
  </div>

  <!-- Profesorado -->
  <div class="col-12 col-lg-6">
    <label class="form-label">Profesorado <span class="text-danger">*</span></label>
    <select id="cmb-prof" name="profesorado" class="form-select">
      {% if profesorados %}
        {% for p in profesorados %}
          <option value="{{ p.id }}" data-tipo="{{ p.tipo|default:'profesorado' }}">{{ p.nombre }}</option>
        {% endfor %}
      {% else %}
        <option disabled selected>No hay profesorados activos</option>
      {% endif %}
    </select>
    <div class="form-text">Si es “Certificación Docente”, cambian los requisitos.</div>
  </div>

  <!-- Plan (dependiente de profesorado) -->
  <div class="col-12 col-lg-6">
      <label class="form-label">Plan de Estudios <span class="text-danger">*</span></label>
      <select id="cmb-plan" name="plan_id" class="form-select">
          <option value="">Seleccioná un plan</option>
      </select>
  </div>

  <!-- Cohorte / Curso introductorio -->
  <div class="col-12">
    <label class="form-label">Cohorte <span class="text-danger">*</span></label>
    <select id="cohorte" name="cohorte" class="form-select">
      {% for anio in cohortes %}<option value="{{ anio }}">{{ anio }}</option>{% endfor %}
    </select>
  </div>

  <div class="col-12">
    <label class="form-label">Curso introductorio</label>
    <select id="curso_intro" name="curso_intro" class="form-select">
      <option value="Aprobado">Aprobado</option>
      <option value="Desaprobado">Desaprobado</option>
    </select>
  </div>

  <div class="col-12 col-md-4 d-flex align-items-end">
    <span id="chip-estado" class="badge text-bg-secondary">ESTADO: —</span>
  </div>

  <div class="col-12 pt-2"><h6 class="text-uppercase text-muted mb-2">Documentación</h6></div>

  <!-- Requisitos base -->
  <div class="row g-2">
    {% for id,label in base_checks %}
      <div class="col-6 col-md-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="{{ id }}" name="{{ id }}">
          <label class="form-check-label" for="{{ id }}">{{ label }}</label>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Grupo Profesorado común -->
  <div id="grp-profesorado" class="row g-2 mt-1">
    <div class="col-12 col-md-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="titulo_secundario_legalizado" name="titulo_secundario_legalizado">
        <label class="form-check-label" for="titulo_secundario_legalizado">Título secundario legalizado</label>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="titulo_en_tramite" name="titulo_en_tramite">
        <label class="form-check-label" for="titulo_en_tramite">Título en trámite</label>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="adeuda_materia" name="adeuda_materia">
        <label class="form-check-label" for="adeuda_materia">Adeuda materia</label>
      </div>
    </div>

    {# Campos de Adeuda: SOLO visibles si "Adeuda materia" está activo #}
    <div id="adeuda_fields" class="col-12 d-none">
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label">Materias adeudadas</label>
          <input type="text" class="form-control" id="materias_adeudadas" name="materias_adeudadas" disabled>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Escuela / Institución</label>
          <input type="text" class="form-control" id="institucion_adeuda" name="institucion_adeuda" disabled>
        </div>
      </div>
    </div>
  </div>

  <!-- Grupo: Certificación Docente -->
  <div id="grp-certificacion" class="row g-2 mt-1 d-none">
    <div class="col-12 col-md-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="titulo_terciario_legalizado" name="titulo_terciario_legalizado">
        <label class="form-check-label" for="titulo_terciario_legalizado">Título terciario/univ. legalizado</label>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="incumbencias_presentadas" name="incumbencias_presentadas">
        <label class="form-check-label" for="incumbencias_presentadas">Incumbencias presentadas</label>
      </div>
    </div>
  </div>

  <!-- Nota compromiso + chip -->
  <div class="col-12 mt-1">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="nota_compromiso" name="nota_compromiso" disabled>
      <label class="form-check-label" for="nota_compromiso">Nota compromiso</label>
      <small class="text-muted d-block">Se habilita automáticamente si falta documentación.</small>
    </div>
  </div>
  <div class="col-12 col-md-4 mt-2">
    <span id="chip-estado" class="badge text-bg-secondary">ESTADO: —</span>
  </div>

  <!-- Acciones -->
  <div class="col-12">
    <div class="d-flex justify-content-start gap-2 pt-2 mt-1 border-top">
      <a href="{% url 'panel' %}?action=section_insc" class="btn btn-outline-secondary">Volver</a>
      <button type="submit" class="btn btn-success px-4">Guardar</button>
    </div>
  </div>
</form>

<script>
(function(){
  const $ = (s) => document.querySelector(s);

  // ---- elementos
  const profSel = $('#cmb-prof');
  const grpProf = $('#grp-profesorado');
  const grpCert = $('#grp-certificacion');

  const chkSec  = $('#titulo_secundario_legalizado');
  const chkTram = $('#titulo_en_tramite');
  const chkAde  = $('#adeuda_materia');

  const adeudaBox = $('#adeuda_fields');
  const inMat  = $('#materias_adeudadas');
  const inIns  = $('#institucion_adeuda');

  const chkTer = $('#titulo_terciario_legalizado');
  const chkInc = $('#incumbencias_presentadas');

  const base = { dni:$('#doc_dni_legalizado'), med:$('#doc_cert_medico'), fot:$('#doc_fotos_carnet'), fol:$('#doc_folios_oficio') };
  const chip = $('#chip-estado');
  const chkNota = $('#nota_compromiso');

  // ---- helpers
  const norm = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  function tipoActual(){
    const opt = profSel?.selectedOptions?.[0];
    const byData = norm(opt?.dataset?.tipo);
    const byText = norm(opt?.textContent);
    if (byData.includes('certificacion') && byData.includes('docent')) return 'certificacion_docente';
    if (byText.includes('certificacion docente')) return 'certificacion_docente';
    return 'profesorado';
  }

  function showAdeudaFields(show){
    adeudaBox?.classList.toggle('d-none', !show);
    if (inMat) inMat.disabled = !show;
    if (inIns) inIns.disabled = !show;
    if (!show){ if (inMat) inMat.value=''; if (inIns) inIns.value=''; }
  }

  function setDisabled(el, disabled){
    if (!el) return;
    el.disabled = disabled;
    if (disabled) el.checked = false;
  }

  function exclusive(which){
    // deja solo UNO entre Sec / Tram / Ade
    if (which === 'sec' && chkSec?.checked){
      setDisabled(chkTram, false); setDisabled(chkAde, false);
      chkTram.checked = false; chkAde.checked = false;
      showAdeudaFields(false);
    }
    if (which === 'tram' && chkTram?.checked){
      setDisabled(chkSec, false); setDisabled(chkAde, false);
      chkSec.checked = false; chkAde.checked = false;
      showAdeudaFields(false);
    }
    if (which === 'ade' && chkAde?.checked){
      setDisabled(chkSec, false); setDisabled(chkTram, false);
      chkSec.checked = false; chkTram.checked = false;
      showAdeudaFields(true);
    }
    if (which === 'ade' && !chkAde?.checked){
      showAdeudaFields(false);
    }
  }

  function calcularEstado(){
    const baseOk = !!(base.dni?.checked && base.med?.checked && base.fot?.checked && base.fol?.checked);
    const t = tipoActual();
    let regular = false;
    if (t === 'certificacion_docente'){
      regular = baseOk && !!(chkTer?.checked && chkInc?.checked);
    } else {
      regular = baseOk && !!chkSec?.checked;
    }
    if (chip){
      chip.textContent = 'ESTADO: ' + (regular ? 'REGULAR' : 'CONDICIONAL');
      chip.className   = 'badge ' + (regular ? 'text-bg-success' : 'text-bg-warning');
    }
    if (chkNota){ chkNota.disabled = regular; chkNota.checked = !regular; }
  }

  function togglePorTipo(){
    const t = tipoActual();
    if (t === 'certificacion_docente'){
      // Mostrar bloque de Certificación; ocultar y deshabilitar el de Secundario/Adeuda
      grpCert?.classList.remove('d-none');
      grpProf?.classList.add('d-none');

      setDisabled(chkSec,  true);
      setDisabled(chkTram, true);
      setDisabled(chkAde,  true);
      showAdeudaFields(false);

      // Habilitar los de certificación
      setDisabled(chkTer, false);
      setDisabled(chkInc, false);
    } else {
      // Mostrar bloque de Secundario/Adeuda; ocultar y deshabilitar certificación
      grpCert?.classList.add('d-none');
      grpProf?.classList.remove('d-none');

      setDisabled(chkTer, true);
      setDisabled(chkInc, true);

      // re-habilitar trio; mantener campos de adeuda según el check
      setDisabled(chkSec,  false);
      setDisabled(chkTram, false);
      setDisabled(chkAde,  false);
      showAdeudaFields(!!chkAde?.checked);
    }
    calcularEstado();
  }

  // ---- eventos
  chkSec?.addEventListener('change', () => { exclusive('sec');  calcularEstado(); });
  chkTram?.addEventListener('change', () => { exclusive('tram'); calcularEstado(); });
  chkAde?.addEventListener('change',  () => { exclusive('ade');  calcularEstado(); });

  ['#dni_legalizado','#certificado_medico','#fotocarnet','#folio_oficio',
   '#titulo_terciario_legalizado','#incumbencias_presentadas',
   '#materias_adeudadas','#institucion_adeuda'
  ].forEach(sel => $(sel)?.addEventListener('input', calcularEstado));

  profSel?.addEventListener('change', togglePorTipo);

  // ---- init
  showAdeudaFields(!!chkAde?.checked);
  togglePorTipo();
  calcularEstado();
})();
</script>

<script>
  const PLANES_MAP = {{ planes_map|safe }}; // { prof_id: [{id,label}, ...], ... }

  const cmbProf = document.getElementById('cmb-prof');
  const cmbPlan = document.getElementById('cmb-plan');

  function renderPlanes() {
    const profId = parseInt(cmbProf.value || 0);
    cmbPlan.innerHTML = '<option value="">Seleccioná un plan</option>';
    (PLANES_MAP[profId] || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.label;
      cmbPlan.appendChild(opt);
    });
    // Si hay un solo plan, auto-seleccionar
    if ((PLANES_MAP[profId] || []).length === 1) {
      cmbPlan.value = PLANES_MAP[profId][0].id;
    }
    cmbPlan.dispatchEvent(new Event('change'));
  }

  cmbProf?.addEventListener('change', renderPlanes);
  document.addEventListener('DOMContentLoaded', renderPlanes);
</script>

        {% elif action == 'insc_esp' %}
<form id="form-insc-materia" class="row g-2 gy-1 compact" novalidate>
  <div class="col-12"><h6 class="text-uppercase text-muted mb-2">INSCRIPCIÓN A MATERIA (CURSADA)</h6></div>

  <!-- Estudiante -->
  <div class="col-12 col-lg-6">
    <label class="form-label">Estudiante <span class="text-danger">*</span></label>
    <select id="esp_estudiante" name="estudiante_id" class="form-select">
      <option value="">Seleccioná…</option>
      {% for e in estudiantes %}
        <option value="{{ e.id }}">{{ e.apellido }}, {{ e.nombre }} — DNI {{ e.dni }}</option>
      {% empty %}
        <option disabled>No hay estudiantes activos</option>
      {% endfor %}
    </select>
  </div>

  <!-- Profesorado -->
  <div class="col-12 col-lg-6">
    <label class="form-label">Profesorado <span class="text-danger">*</span></label>
    <select id="esp_profesorado" name="profesorado_id" class="form-select" {% if not profesorados %}disabled{% endif %}>
      <option value="">{{ profesorados|length|yesno:"Seleccioná…,No hay profesorados" }}</option>
      {% for p in profesorados %}
        <option value="{{ p.id }}" data-tipo="{{ p.tipo|default:'profesorado' }}">{{ p.nombre }}</option>
      {% endfor %}
    </select>
    <div class="form-text">Las materias se filtran por profesorado y período.</div>
  </div>

  <!-- Ciclo lectivo -->
  <div class="col-12 col-md-4">
    <label class="form-label">Ciclo lectivo <span class="text-danger">*</span></label>
    <select id="esp_ciclo" name="ciclo" class="form-select">
      {% for a in ciclos %}<option value="{{ a }}">{{ a }}</option>{% endfor %}
    </select>
  </div>

  <!-- Período -->
  <div class="col-12 col-md-4">
    <label class="form-label">Período</label>
    <select id="esp_periodo" name="periodo" class="form-select">
      {% for v,txt in periodos %}<option value="{{ v }}">{{ txt }}</option>{% endfor %}
    </select>
  </div>

  <!-- Espacio curricular (filtrado) -->
  <div class="col-12 col-md-4">
    <label class="form-label">Espacio curricular <span class="text-danger">*</span></label>
    <select id="esp_materia" name="espacio_id" class="form-select" {% if not espacios %}disabled{% endif %}>
      <option value="">{{ espacios|length|yesno:"Seleccioná…,No hay espacios" }}</option>
      {% for m in espacios %}
        <option value="{{ m.id }}" data-prof="{{ m.profesorado_id }}" data-per="{{ m.periodo|default:'ANUAL' }}">{{ m.nombre }}</option>
      {% endfor %}
    </select>
    <div id="esp_materia_help" class="form-text text-muted"></div>
  </div>

  <!-- Opcionales -->
  <div class="col-12 col-md-4">
    <label class="form-label">Comisión (opcional)</label>
    <input type="text" id="esp_comision" name="comision" class="form-control" placeholder="Ej: A / B / Única">
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">Turno (opcional)</label>
    <select id="esp_turno" name="turno" class="form-select">
      <option value="">—</option>
      <option>Mañana</option>
      <option>Tarde</option>
      <option>Noche</option>
    </select>
  </div>

  <div class="col-12">
    <div class="d-flex justify-content-start gap-2 pt-2 mt-1 border-top">
      <a href="{% url 'panel' %}?action=section_insc" class="btn btn-outline-secondary">Volver</a>
      <button type="submit" class="btn btn-success px-4">Guardar</button>
    </div>
  </div>
</form>

<script>
(function(){
  const $ = (s) => document.querySelector(s);
  const selProf = $('#esp_profesorado');
  const selPer  = $('#esp_periodo');
  const selMat  = $('#esp_materia');
  const helpMat = $('#esp_materia_help');

  function filtrarMaterias(){
    const prof = selProf?.value || '';
    const per  = (selPer?.value || 'ANUAL').toUpperCase();
    if (!selMat) return;

    let visibles = 0;
    Array.from(selMat.options).forEach((opt, idx) => {
      if (idx === 0) return; // placeholder
      const oProf = (opt.dataset.prof || '');
      const oPer  = (opt.dataset.per  || 'ANUAL').toUpperCase();

      const okProf = prof ? (oProf === prof) : true;
      const okPer  = (per === 'ANUAL') ? true : (oPer === per || oPer === 'ANUAL');

      const show = !!(okProf && okPer);
      opt.hidden = !show;
      if (show) visibles += 1;
    });

    if (visibles === 0) {
      selMat.disabled = true;
      selMat.value = '';
      if (helpMat) helpMat.textContent = 'No hay espacios para el filtro seleccionado.';
    } else {
      selMat.disabled = false;
      const cur = selMat.selectedOptions[0];
      if (!cur || cur.hidden) {
        const firstVisible = Array.from(selMat.options).find((o, i) => i>0 && !o.hidden);
        if (firstVisible) selMat.value = firstVisible.value;
      }
      if (helpMat) helpMat.textContent = '';
    }
  }

  selProf?.addEventListener('change', filtrarMaterias);
  selPer ?.addEventListener('change', filtrarMaterias);
  filtrarMaterias(); // init
})();
</script>

        {# ===================== NUEVO ESTUDIANTE ===================== #}
        {% elif action == 'add_est' %}
          <form method="post" action="{% url 'panel' %}?action=add_est" enctype="multipart/form-data" class="row g-2 gy-1 compact" novalidate>
  {% csrf_token %}

  <!-- ===== DATOS PERSONALES ===== -->
  <div class="col-12"><h6 class="text-uppercase text-muted mb-2">Datos personales</h6></div>

  <!-- Fila 1: DNI / Apellido / Nombre -->
  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">DNI <span class="text-danger">*</span></label>
    <input type="text" class="form-control" name="dni" inputmode="numeric" placeholder="Ej: 12345678" required>
  </div>

  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Apellido <span class="text-danger">*</span></label>
    <input type="text" class="form-control" name="apellido" autocomplete="family-name" required>
  </div>

  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Nombre <span class="text-danger">*</span></label>
    <input type="text" class="form-control" name="nombre" autocomplete="given-name" required>
  </div>

  <!-- Fila 2: Fecha / Lugar / Activo -->
  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Fecha nacimiento</label>
    <input type="date" class="form-control" name="fecha_nacimiento">
  </div>

  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Lugar nacimiento</label>
    <input type="text" class="form-control" name="lugar_nacimiento" placeholder="Ciudad, provincia">
  </div>

  <div class="col-12 col-md-6 col-xl-4 d-flex align-items-end">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="activo" name="activo" checked>
      <label class="form-check-label" for="activo">Activo</label>
    </div>
  </div>

  <!-- ===== CONTACTO ===== -->
  <div class="col-12 pt-2"><h6 class="text-uppercase text-muted mb-2">Contacto</h6></div>

  <!-- Fila 3: Email / Teléfono / Localidad -->
  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Email</label>
    <input type="email" class="form-control" name="email" autocomplete="email" placeholder="nombre @dominio.com">
  </div>

  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Teléfono</label>
    <input type="tel" class="form-control" name="telefono" inputmode="tel" placeholder="Ej: 11 1234 5678">
  </div>

  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Localidad</label>
    <input type="text" class="form-control" name="localidad" autocomplete="address-level2">
  </div>

  <!-- ===== EMERGENCIA ===== -->
  <div class="col-12 pt-2"><h6 class="text-uppercase text-muted mb-2">Emergencia</h6></div>

  <!-- Fila 4: Tel. emergencia / Parentesco / (vacío) -->
  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Tel. de emergencia</label>
    <input type="tel" class="form-control" name="telefono_emergencia" inputmode="tel">
  </div>

  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Parentesco (opcional)</label>
    <input type="text" class="form-control" name="parentesco">
  </div>

  <div class="col-12 col-md-6 col-xl-4 d-none d-xl-block"></div>

  <!-- ===== FOTO ===== -->
  <div class="col-12 pt-2"><h6 class="text-uppercase text-muted mb-2">Foto</h6></div>

  <!-- Fila 5: Archivo / Preview / (vacío) -->
  <div class="col-12 col-md-6 col-xl-4">
    <label class="form-label">Foto</label>
    <input type="file" class="form-control" name="foto" accept="image/*" id="fotoInput">
    <div class="form-text">JPG o PNG, máx. 2MB.</div>
  </div>

  <div class="col-12 col-md-6 col-xl-4 d-flex align-items-end">
    <img id="fotoPreview" class="rounded-3 border" style="width:110px;height:110px;object-fit:cover;display:none;">
  </div>

  <div class="col-12 col-md-6 col-xl-4 d-none d-xl-block"></div>

  <!-- ===== ACCIONES ===== -->
  <div class="col-12">
    <div class="d-flex justify-content-start gap-2 pt-2 mt-1 border-top">
      <a href="{% url 'panel' %}?action=section_est" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-success px-4">Guardar</button>
    </div>
  </div>
</form>

<script>
  // Preview de la foto
  const input = document.getElementById('fotoInput');
  const preview = document.getElementById('fotoPreview');
  input?.addEventListener('change', e => {
    const f = e.target.files?.[0];
    if (!f) { preview.style.display='none'; return; }
    preview.src = URL.createObjectURL(f);
    preview.style.display = 'block';
  });
</script>
        {% endif %}
      </div>
    </main>
  </div>

<style>
/* ===== Página (pastel muy suave) ===== */
:root{
  --bg-app:   #f2cbbd;   /* fondo general */
  --surface:  #fffaf7;   /* panel del formulario (apenas teñido) */
  --field-bd: #e7e2dc;   /* borde de inputs */
  --ring:     #ffb899;   /* color de foco */
  --muted:    #6b7280;
}

html, body { min-height: 100%; }
body, body.bg-light, .bg-light{
  background: var(--bg-app) !important;
  background-color: var(--bg-app) !important;
}

/* Panel del formulario */
.form-surface{
  background: var(--surface) !important;
  border: 1px solid rgba(0,0,0,.04);
  box-shadow: 0 6px 20px rgba(0,0,0,.04);
}

/* Inputs/combobox blancos */
.form-surface .form-control,
.form-surface .form-select,
.form-surface .form-control:hover,
.form-surface .form-select:hover,
.form-surface .form-control:focus,
.form-surface .form-select:focus{
  background-color: #ffffff !important;
}

/* Borde y foco suaves */
.form-surface .form-control,
.form-surface .form-select{ border-color: var(--field-bd); }
.form-surface .form-control:focus,
.form-surface .form-select:focus{
  border-color: var(--ring);
  box-shadow: 0 0 0 .2rem rgba(255,184,153,.25);
  outline: none;
}

/* Placeholders más tenues */
.form-surface .form-control::placeholder{
  color: color-mix(in srgb, var(--muted) 60%, white);
}

/* Sidebar & Topbar */
.sidebar-surface,
.topbar-surface{
  background: var(--surface) !important;
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 4px 18px rgba(0,0,0,.04);
}
.topbar-surface{ border-radius: 0 0 12px 12px; }
.sidebar-surface{ border-radius: 12px; }
.sidebar-surface .nav-link{ color: #1f2937; }
.sidebar-surface .nav-link:hover{ background: #fff; border-radius: .5rem; }
.sidebar-surface .nav-link.active{ box-shadow: inset 0 0 0 1px var(--field-bd); }

/* Compactación */
.compact{ font-size:.94rem; }
.compact .form-label{ font-weight:600; font-size:.9rem; margin-bottom:.2rem; }
.compact .form-control,
.compact .form-select,
.compact .form-check-input{ padding:.35rem .5rem; font-size:.9rem; }
.compact .btn{ padding:.4rem .75rem; font-size:.9rem; }

/* Scroll interno */
.main-scroll{ max-height: calc(100vh - 120px) !important; overflow:auto; }

 @media (max-width: 991.98px){
  .compact .row{ --bs-gutter-y: .6rem; }
}
</style>
{% endblock %}