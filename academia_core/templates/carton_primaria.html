<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Cartón - {{ estudiante.apellido }}, {{ estudiante.nombre }}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px 0; }

    /* Botonera */
    .toolbar { display:flex; gap:8px; justify-content:flex-end; margin: 10px 0 14px; }
    .btn{
      border:1px solid #999; background:#f8f8f8; padding:6px 10px; border-radius:6px;
      cursor:pointer; font-size:14px; text-decoration:none; color:#111;
      display:inline-block;
    }
    .btn:hover{ background:#eee; }

    /* Ocultar botones al imprimir */
    @media print{
      .toolbar { display:none !important; }
      body{ margin:0; }
    }

    /* badges */
    .badge {
      display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px;
      background:#e5e7eb; color:#111827; border:1px solid #d1d5db;
    }
    .badge.ok   { background:#dcfce7; border-color:#86efac; color:#065f46; }
    .badge.warn { background:#fee2e2; border-color:#fecaca; color:#991b1b; }

    /* cabecera con dos tablas y la foto */
    .cabecera-grid{
      display:grid; grid-template-columns: 1fr 1fr auto; gap:24px; align-items:start;
      margin-bottom: 16px;
    }
    .box{ overflow:hidden; }

    .cabecera-grid table,
    .main-grid table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:14px;
    }
    th, td { border:1px solid #999; padding:6px 8px; }
    th { background:#efefef; text-align:left; }

    .foto-alumno{
      width:110px; height:140px; object-fit:cover;
      border:1px solid #ccc; border-radius:4px;
      display:block;
    }

    /* tabla principal */
    .w-espacio { min-width:320px; }
    .center { text-align:center; }
    tbody tr:nth-child(odd) td { background:#fafafa; }
  </style>
</head>
<body>

  <h1>Cartón Académico – {{ profesorado.nombre }}</h1>

  <!-- Botonera -->
  <div class="toolbar">
    {% if request.user.is_authenticated and request.user.perfil and request.user.perfil.rol == "ESTUDIANTE" %}
      <a href="{% url 'alumno_home' %}" class="btn">← Volver a Mi Cursada</a>
    {% endif %}
    <a class="btn" href="{% url 'carton_generico_pdf' profesorado.slug plan.resolucion_slug estudiante.dni %}" target="_blank" rel="noopener">Descargar PDF</a>
    <button class="btn" onclick="window.print()">Imprimir</button>
  </div>

  <div style="margin-bottom:8px;">
    <strong>Estudiante:</strong>
    {{ estudiante.apellido }}, {{ estudiante.nombre }} (DNI {{ estudiante.dni }})
  </div>

  <div class="cabecera-grid">
    <!-- Columna izquierda -->
    <div class="box">
      <table>
        <tr>
          <th style="width:18%;">Fecha Nac.</th>
          <td style="width:32%;">{{ estudiante.fecha_nacimiento|date:"d/m/Y" }}</td>
          <th style="width:18%;">Email</th>
          <td style="width:32%;">{{ estudiante.email|default:"—" }}</td>
        </tr>
        <tr>
          <th>Teléfono</th>
          <td>{{ estudiante.telefono|default:"—" }}</td>
          <th>Localidad</th>
          <td>{{ estudiante.localidad|default:"—" }}</td>
        </tr>
        <tr>
          <th>Cohorte</th>
          <td>{{ inscripcion.cohorte|default:"—" }}</td>
          <th>Curso Introductorio</th>
          <td>{{ inscripcion.curso_introductorio|default:"—" }}</td>
        </tr>
        <tr>
          <th>Libreta / Legajo</th>
          <td>{{ inscripcion.libreta|default:"—" }} / {{ inscripcion.legajo|default:"—" }}</td>
          <th>Plan</th>
          <td>Res. {{ plan.resolucion }}{% if plan.nombre %} ({{ plan.nombre }}){% endif %}</td>
        </tr>
      </table>
    </div>

    <!-- Columna derecha (sin duplicados) -->
    <div class="box">
      <table>
        <tr>
          <th>Legajo (estado)</th>
          <td>
            {% if inscripcion.legajo_estado == "Completo" %}
              <span class="badge ok">Completo</span>
            {% else %}
              <span class="badge warn">Incompleto</span>
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>Promedio General</th>
          <td>{% if inscripcion.promedio_general %}{{ inscripcion.promedio_general }}{% else %}—{% endif %}</td>
        </tr>
      </table>
    </div>

    <!-- Foto -->
    <div class="box" style="justify-self:end;">
      {% if estudiante.foto %}
        <img src="{{ estudiante.foto.url }}" alt="Foto del estudiante" class="foto-alumno">
      {% else %}
        <div class="foto-alumno" style="display:flex;align-items:center;justify-content:center;color:#999;">
          sin foto
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Grilla con histórico por materia (todas las REG y FIN) -->
  <table class="main-grid">
    <thead>
      <tr>
        <th style="width:60px;">Año</th>
        <th style="width:70px;">Cuatr.</th>
        <th class="w-espacio">Espacio Curricular</th>
        <th style="width:110px;">Fecha REG</th>
        <th style="width:120px;">Cond. REG</th>
        <th style="width:110px;">Nota REG</th>
        <th style="width:110px;">Fecha FIN</th>
        <th style="width:110px;">Cond. FIN</th>
        <th style="width:110px;">Nota FIN</th>
        <th style="width:70px;">Folio</th>
        <th style="width:70px;">Libro</th>
      </tr>
    </thead>
    <tbody>
      {% for b in bloques %}
        <!-- primera fila del bloque -->
        <tr>
          <td class="center" rowspan="{{ b.rows|length }}">{{ b.anio }}</td>
          <td class="center" rowspan="{{ b.rows|length }}">{{ b.cuatri }}</td>
          <td rowspan="{{ b.rows|length }}">{{ b.espacio }}</td>

          <td class="center">{{ b.rows.0.reg_fecha }}</td>
          <td class="center">{{ b.rows.0.reg_cond }}</td>
          <td class="center">{{ b.rows.0.reg_nota }}</td>
          <td class="center">{{ b.rows.0.fin_fecha }}</td>
          <td class="center">{{ b.rows.0.fin_cond }}</td>
          <td class="center">{{ b.rows.0.fin_nota }}</td>
          <td class="center">{{ b.rows.0.folio }}</td>
          <td class="center">{{ b.rows.0.libro }}</td>
        </tr>

        <!-- filas siguientes del bloque -->
        {% for row in b.rows|slice:"1:" %}
          <tr>
            <td class="center">{{ row.reg_fecha }}</td>
            <td class="center">{{ row.reg_cond }}</td>
            <td class="center">{{ row.reg_nota }}</td>
            <td class="center">{{ row.fin_fecha }}</td>
            <td class="center">{{ row.fin_cond }}</td>
            <td class="center">{{ row.fin_nota }}</td>
            <td class="center">{{ row.folio }}</td>
            <td class="center">{{ row.libro }}</td>
          </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>

</body>
</html>
